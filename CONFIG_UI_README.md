# 任务配置界面使用说明

## 功能概述

这个功能为 DST 手柄增强 Mod 添加了一个游戏内 HUD 配置界面，允许你在游戏中直接配置按钮组合的动作，支持多个动作序列和参数配置。

## 使用方法

### 打开配置界面

在游戏中按下 **Ctrl + K** 快捷键即可打开配置界面。

### 控制方式

配置界面完全支持键鼠和手柄操作：

#### 🎮 手柄操作
- **左摇杆/D-Pad**: 上下移动光标选择项目
- **A键**: 确认选择/进入配置
- **B键**: 返回/关闭界面
- **LB键**: 切换到"按下动作"标签页（在详细配置界面）
- **RB键**: 切换到"松开动作"标签页（在详细配置界面）

#### ⌨️ 键盘鼠标操作
- **鼠标**: 点击按钮和选项
- **Enter**: 确认选择
- **ESC**: 返回/关闭界面
- **Ctrl + K**: 打开配置界面（全局快捷键）

### 配置流程

1. **选择按钮组合**
   - 配置界面显示所有可用的按钮组合
   - **LB 组合**: LB+A, LB+B, LB+X, LB+Y, LB+LT, LB+RT
   - **RB 组合**: RB+A, RB+B, RB+X, RB+Y, RB+LT, RB+RT
   - 点击任意按钮旁的"配置"按钮进入详细配置

2. **详细配置界面**
   - 使用标签页切换"按下动作"和"松开动作"配置
   - 可以为每个事件添加多个动作，按顺序执行
   - 点击"+ 添加动作"按钮添加新动作
   - 点击"↑"按钮将动作上移（调整执行顺序）
   - 点击"↓"按钮将动作下移（调整执行顺序）
   - 点击"编辑"修改现有动作
   - 点击"删除"移除动作

3. **编辑动作**
   - **选择动作类型**: 从下拉列表中选择动作（如攻击、检查、装备物品等）
   - **配置参数**（如果需要）:
     - 对于需要参数的动作（如"装备物品"），会显示参数选择器
     - 可以从预设列表中选择常用物品
     - 选择"【自定义输入】"可以手动输入物品名称

### 可用动作列表

#### 无参数动作
- **无动作**: 不执行任何操作
- **攻击**: 执行攻击动作
- **强制攻击**: 强制攻击目标（无视友好状态）
- **检查**: 检查物品或生物
- **检查自己**: 检查玩家自身
- **保存手持物品**: 保存当前手持的物品
- **恢复手持物品**: 恢复之前保存的物品
- **开始持续动作**: 开始持续按键动作（如使用打火机）
- **停止持续动作**: 停止持续按键动作
- **切换头部装备**: 切换头部槽位的装备
- **切换手部装备**: 切换手部槽位的装备
- **切换身体装备**: 切换身体槽位的装备

#### 需要参数的动作
- **装备物品**: 装备指定物品（需要参数：物品名称）
- **使用物品**: 使用指定物品（需要参数：物品名称）
- **对自己使用物品**: 对自己使用物品（需要参数：物品名称）
- **制作物品**: 制作指定物品（需要参数：配方名称）

#### 常用物品参数预设
- lighter (打火机)
- torch (火把)
- lantern (提灯)
- pickaxe (镐子)
- axe (斧头)
- shovel (铲子)
- hammer (锤子)
- spear (长矛)
- log (木头)
- cutgrass (草)
- twigs (树枝)
- rocks (石头)
- flint (燧石)
- goldnugget (金块)

### 保存配置

1. 配置完成后，点击"应用"按钮
2. 配置会立即生效，无需重启游戏
3. 新配置将打印到控制台，你可以复制并保存到 `scripts/config/tasks.lua` 文件中以永久保存

### 关闭配置界面

- 点击"关闭"按钮
- 或按下 **ESC** 键

## 技术细节

### 文件结构

```
scripts/
├── screens/
│   └── taskconfig_screen.lua    # 配置界面 UI 组件
├── hooks/
│   └── taskconfig-hook.lua      # 快捷键监听和界面管理
└── utils/
    └── config_manager.lua        # 配置加载和保存管理
```

### 配置流程

1. **加载**: `ConfigManager.LoadTasks()` 从 `scripts/config/tasks.lua` 加载配置
2. **运行时更新**: 用户在界面中修改配置，保存在内存中
3. **应用**: `ConfigManager.SaveTasks()` 将配置打印到控制台，并更新运行时配置
4. **生效**: `controller-hook` 每次处理按键时都会获取最新的运行时配置

### 动态配置加载

修改后的 `controller-hook.lua` 现在使用 `ConfigManager.GetRuntimeTasks()` 动态获取配置，这意味着：
- 配置更改立即生效
- 无需重新加载 Mod 或重启游戏
- 支持游戏过程中实时调整按钮配置

## 配置示例

### 示例 1: LB+B 使用打火机（多动作序列）

**按下动作序列**:
1. 保存手持物品
2. 装备物品(lighter) - 装备打火机
3. 开始持续动作 - 开始使用打火机

**松开动作序列**:
1. 停止持续动作 - 停止使用打火机
2. 恢复手持物品 - 恢复之前的物品

### 示例 2: RB+Y 切换头部装备

**按下动作**:
- 切换头部装备

**松开动作**:
- 无动作

### 示例 3: LB+A 强制攻击

**按下动作**:
- 强制攻击

**松开动作**:
- 无动作

### 示例 4: 快速使用物品

**按下动作序列**:
1. 保存手持物品
2. 装备物品(torch) - 装备火把
3. 使用物品(torch) - 点燃火把

**松开动作**:
- 恢复手持物品

## 注意事项

1. **DST 文件系统限制**: 由于 DST 的沙箱环境限制，Mod 无法直接写入文件。配置会打印到控制台，需要手动复制到配置文件以永久保存。

2. **运行时配置**: 在游戏会话期间，配置保存在内存中并立即生效。但游戏重启后会恢复到 `tasks.lua` 文件中的配置。

3. **控制台查看**: 打开游戏控制台（通常是 `~` 键）可以查看配置保存的 Lua 代码。

4. **物品名称**: 使用"装备物品"等需要参数的动作时，物品名称必须是游戏内部的 prefab 名称（如 lighter、torch），而不是显示名称。

5. **自定义参数输入**: 由于 DST 的 TextEdit 组件限制，目前"自定义参数"选项会显示提示文本。建议从预设列表中选择，或在保存后手动编辑配置文件来添加自定义参数。

## 界面预览

### 1️⃣ 主配置界面 (TaskConfigScreen)

```
╔═══════════════════════════════════════════════════════════╗
║                    控制器任务配置                          ║
║              点击按钮组合进行详细配置                       ║
╠═══════════════════════════════════════════════════════════╣
║                                                           ║
║  LB + A    按下:1个动作  松开:0个动作      [  配置  ]     ║
║  ─────────────────────────────────────────────────────    ║
║  LB + B    按下:3个动作  松开:2个动作      [  配置  ]     ║
║  ─────────────────────────────────────────────────────    ║
║  LB + X    按下:0个动作  松开:0个动作      [  配置  ]     ║
║  ─────────────────────────────────────────────────────    ║
║  LB + Y    按下:1个动作  松开:0个动作      [  配置  ]     ║
║  ─────────────────────────────────────────────────────    ║
║  LB + LT   按下:0个动作  松开:0个动作      [  配置  ]     ║
║  ─────────────────────────────────────────────────────    ║
║  LB + RT   按下:0个动作  松开:0个动作      [  配置  ]     ║
║  ─────────────────────────────────────────────────────    ║
║  RB + A    按下:0个动作  松开:0个动作      [  配置  ]     ║
║  ─────────────────────────────────────────────────────    ║
║  RB + B    按下:1个动作  松开:0个动作      [  配置  ]     ║
║  ─────────────────────────────────────────────────────    ║
║  RB + X    按下:1个动作  松开:0个动作      [  配置  ]     ║
║  ─────────────────────────────────────────────────────    ║
║  RB + Y    按下:1个动作  松开:0个动作      [  配置  ]     ║
║  ─────────────────────────────────────────────────────    ║
║  RB + LT   按下:0个动作  松开:0个动作      [  配置  ]     ║
║  ─────────────────────────────────────────────────────    ║
║  RB + RT   按下:0个动作  松开:0个动作      [  配置  ]     ║
║                                                           ║
╠═══════════════════════════════════════════════════════════╣
║                 [  应 用  ]      [  关 闭  ]              ║
╚═══════════════════════════════════════════════════════════╝
```

**说明**：显示所有12个按钮组合，每个显示当前配置的动作数量，点击"配置"进入详细配置。

---

### 2️⃣ 详细配置界面 (ActionDetailScreen)

点击"LB + B"的"配置"按钮后：

```
╔═══════════════════════════════════════════════════════════╗
║               LB + B - 动作配置                            ║
╠═══════════════════════════════════════════════════════════╣
║                                                           ║
║        [ 按下动作 ]         [ 松开动作 ]                  ║
║         (高亮显示)            (正常显示)                  ║
║                                                           ║
╟───────────────────────────────────────────────────────────╢
║                      【按下动作列表】                      ║
║                                                           ║
║  1.  ↓  save_hand_item              [编辑]  [删除]       ║
║  ─────────────────────────────────────────────────────   ║
║  2.  ↑↓ equip_item(lighter)         [编辑]  [删除]       ║
║  ─────────────────────────────────────────────────────   ║
║  3.  ↑  start_channeling            [编辑]  [删除]       ║
║                                                           ║
║                    [ + 添加动作 ]                         ║
║                                                           ║
╠═══════════════════════════════════════════════════════════╣
║              [  保 存  ]      [  取 消  ]                 ║
╚═══════════════════════════════════════════════════════════╝
```

**说明**：

- 标签页可切换"按下动作"和"松开动作"
- 每个动作显示序号、移动按钮、动作内容
- 第一个动作只显示↓按钮，最后一个只显示↑按钮
- 中间的动作显示↑↓两个按钮

点击"松开动作"标签页后：

```
╔═══════════════════════════════════════════════════════════╗
║               LB + B - 动作配置                            ║
╠═══════════════════════════════════════════════════════════╣
║                                                           ║
║        [ 按下动作 ]         [ 松开动作 ]                  ║
║         (正常显示)            (高亮显示)                  ║
║                                                           ║
╟───────────────────────────────────────────────────────────╢
║                      【松开动作列表】                      ║
║                                                           ║
║  1.  ↓  stop_channeling             [编辑]  [删除]       ║
║  ─────────────────────────────────────────────────────   ║
║  2.  ↑  restore_hand_item           [编辑]  [删除]       ║
║                                                           ║
║                    [ + 添加动作 ]                         ║
║                                                           ║
╠═══════════════════════════════════════════════════════════╣
║              [  保 存  ]      [  取 消  ]                 ║
╚═══════════════════════════════════════════════════════════╝
```

**空列表状态**：

```
╔═══════════════════════════════════════════════════════════╗
║               RB + A - 动作配置                            ║
╠═══════════════════════════════════════════════════════════╣
║                                                           ║
║        [ 按下动作 ]         [ 松开动作 ]                  ║
║         (高亮显示)            (正常显示)                  ║
║                                                           ║
╟───────────────────────────────────────────────────────────╢
║                                                           ║
║               暂无动作，点击下方'添加动作'按钮              ║
║                                                           ║
║                    [ + 添加动作 ]                         ║
║                                                           ║
╠═══════════════════════════════════════════════════════════╣
║              [  保 存  ]      [  取 消  ]                 ║
╚═══════════════════════════════════════════════════════════╝
```

---

### 3️⃣ 动作编辑对话框 (ActionEditorDialog)

#### 情况A：编辑无参数动作

点击"编辑"按钮，编辑"save_hand_item"动作：

```
╔════════════════════════════════════════════╗
║              编辑动作                       ║
╠════════════════════════════════════════════╣
║                                            ║
║  动作类型:  [ 保存手持物品 ▼ ]             ║
║             ─────────────────              ║
║             攻击                           ║
║             强制攻击                       ║
║          ✓  保存手持物品                   ║
║             恢复手持物品                   ║
║             ...                            ║
║                                            ║
║  (无需参数的动作)                          ║
║                                            ║
╠════════════════════════════════════════════╣
║        [  保 存  ]    [  取 消  ]          ║
╚════════════════════════════════════════════╝
```

#### 情况B：编辑带参数动作（从预设选择）

点击"编辑"按钮，编辑"equip_item(lighter)"动作：

```
╔════════════════════════════════════════════╗
║              编辑动作                       ║
╠════════════════════════════════════════════╣
║                                            ║
║  动作类型:  [ 装备物品 [需要参数] ▼ ]      ║
║             ─────────────────              ║
║             攻击                           ║
║             检查                           ║
║          ✓  装备物品 [需要参数]            ║
║             使用物品 [需要参数]            ║
║             ...                            ║
║                                            ║
║  参数:      [ 打火机 (lighter) ▼ ]        ║
║             ─────────────────              ║
║             【自定义输入】                 ║
║          ✓  打火机 (lighter)               ║
║             火把 (torch)                   ║
║             提灯 (lantern)                 ║
║             镐子 (pickaxe)                 ║
║             ...                            ║
║                                            ║
╠════════════════════════════════════════════╣
║        [  保 存  ]    [  取 消  ]          ║
╚════════════════════════════════════════════╝
```

#### 情况C：自定义参数输入（选择"【自定义输入】"）

```
╔════════════════════════════════════════════╗
║              编辑动作                       ║
╠════════════════════════════════════════════╣
║                                            ║
║  动作类型:  [ 装备物品 [需要参数] ▼ ]      ║
║                                            ║
║  参数:      [ 【自定义输入】 ▼ ]           ║
║                                            ║
║  ╭──────────────────────────────╮         ║
║  │ 自定义参数:                   │         ║
║  │                               │         ║
║  │  ┌─────────────────────────┐ │         ║
║  │  │  my_custom_item         │ │         ║
║  │  └─────────────────────────┘ │         ║
║  │                               │         ║
║  │  提示：请在参数下拉中选择或   │         ║
║  │  在配置文件中手动编辑         │         ║
║  ╰──────────────────────────────╯         ║
║                                            ║
╠════════════════════════════════════════════╣
║        [  保 存  ]    [  取 消  ]          ║
╚════════════════════════════════════════════╝
```

---

## 界面层级结构图

```
主配置界面 (TaskConfigScreen)
├─ 按钮列表（12个按钮组合）
│  ├─ LB + A  [配置] ──┐
│  ├─ LB + B  [配置] ──┤
│  ├─ ...             │
│  └─ RB + RT [配置] ──┘
│
└─ 点击"配置"按钮 ──────────→ 详细配置界面 (ActionDetailScreen)
                              ├─ 标签页切换
                              │  ├─ [按下动作]  ← 当前显示
                              │  └─ [松开动作]
                              │
                              ├─ 动作列表（按序号排列）
                              │  ├─ 1. ↓  动作名称  [编辑][删除] ──┐
                              │  ├─ 2. ↑↓ 动作名称  [编辑][删除] ──┤
                              │  └─ 3. ↑  动作名称  [编辑][删除] ──┤
                              │                                   │
                              ├─ [+ 添加动作] ────────────────────┤
                              │                                   │
                              └─ [保存] [取消]                    │
                                                                  ↓
                                               动作编辑对话框 (ActionEditorDialog)
                                               ├─ 动作类型选择器（Spinner）
                                               │  └─ 下拉列表（16种动作）
                                               │
                                               ├─ 参数面板（条件显示）
                                               │  ├─ 参数选择器（Spinner）
                                               │  │  └─ 预设列表（14种常用物品）
                                               │  │
                                               │  └─ 自定义输入面板（可选）
                                               │     └─ 参数输入提示
                                               │
                                               └─ [保存] [取消]
```

## 技术特性

✅ **多动作序列**: 支持为每个按钮配置多个动作，按顺序执行
✅ **参数化动作**: 支持带参数的动作（如装备指定物品）
✅ **参数预设**: 常用物品有预设选项，方便快速选择
✅ **三层界面**: 主界面 → 详细配置 → 动作编辑，清晰的层级结构
✅ **实时生效**: 配置更改立即生效，无需重启游戏
✅ **动作管理**: 支持添加、编辑、删除、上移、下移动作
✅ **顺序调整**: 使用↑↓按钮轻松调整动作执行顺序
✅ **手柄支持**: 完整支持手柄操作，自动显示对应的按键提示
✅ **智能帮助**: 根据输入设备（键鼠/手柄）自动显示对应操作提示

## 界面按钮说明

### 主配置界面
- **配置** - 进入详细配置界面
- **应用** - 保存所有配置更改
- **关闭** - 退出配置界面

### 详细配置界面
- **按下动作 / 松开动作** - 标签页切换（手柄可用LB/RB快速切换）
- **↑** - 上移动作：将当前动作向上移动一位（第一个动作不显示）
- **↓** - 下移动作：将当前动作向下移动一位（最后一个动作不显示）
- **编辑** - 修改动作类型和参数
- **删除** - 从列表中移除该动作
- **+ 添加动作** - 添加新动作到列表
- **保存** - 保存当前按钮的配置
- **取消** - 放弃更改并返回

### 动作编辑对话框
- **动作类型下拉** - 选择要执行的动作
- **参数下拉** - 选择动作参数（如果需要）
- **保存** - 保存动作配置
- **取消** - 放弃更改并返回

## 使用技巧

1. **调整动作顺序**: 使用↑↓按钮快速调整执行顺序，无需删除重建
2. **复杂序列**: 可以先添加所有动作，再用↑↓调整到合适的顺序
3. **快速测试**: 配置后立即生效，可以进入游戏测试，按Ctrl+K再次调整
4. **手柄导航**: 使用手柄时，LB/RB键可以快速切换"按下动作"和"松开动作"标签页
5. **帮助提示**: 每个界面底部都会显示当前可用的操作提示

## 未来改进

- [ ] 添加真正的文本输入功能（需要实现 TextEdit 组件）
- [ ] 添加导入/导出配置文件功能
- [ ] 提供预设配置模板
- [ ] 添加动作复制/粘贴功能
- [ ] 改进 UI 视觉效果和动画
- [ ] 添加快捷键支持（如 Ctrl+↑/↓ 移动动作）
